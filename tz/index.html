<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>物料查询系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">物料查询系统</h1>

  <!-- 查询输入区 -->
  <div class="w-full max-w-4xl bg-white p-6 rounded-2xl shadow mb-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <input id="supplier" type="text" placeholder="供应商名称" class="border p-2 rounded w-full" />
      <input id="projectId" type="text" placeholder="项目号" class="border p-2 rounded w-full" />
      <input id="projectName" type="text" placeholder="项目名称" class="border p-2 rounded w-full" />
      <button id="searchBtn" class="bg-blue-600 text-white rounded p-2 hover:bg-blue-700">查询</button>
    </div>
  </div>

  <!-- 查询结果表格 -->
  <div class="w-full max-w-6xl bg-white p-6 rounded-2xl shadow">
    <table class="min-w-full border border-gray-300 text-sm text-gray-700">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-3 py-2">合同编号</th>
          <th class="border px-3 py-2">供应商名称</th>
          <th class="border px-3 py-2">项目号</th>
          <th class="border px-3 py-2">项目名称</th>
          <th class="border px-3 py-2">数量</th>
          <th class="border px-3 py-2">单位</th>
          <th class="border px-3 py-2">采购单价</th>
          <th class="border px-3 py-2">订单总额</th>
        </tr>
      </thead>
      <tbody id="resultTable">
        <tr><td colspan="8" class="text-center text-gray-400 py-4">请输入查询条件后点击查询</td></tr>
      </tbody>
    </table>

    <!-- 金额总计 -->
    <div id="totalAmount" class="text-right text-lg font-semibold text-gray-800 mt-4"></div>
  </div>

  <!-- 页脚 -->
  <footer class="mt-10 text-gray-500 text-sm">
    © 2025 由王维设计，只能查询包材和原料。
  </footer>

  <script>
    async function loadData() {
      try {
        const url = 'data.json?t=' + Date.now();
        console.log("尝试加载数据文件：", url);
        const response = await fetch(url);
        if (!response.ok) throw new Error("HTTP状态 " + response.status);
        const json = await response.json();
        console.log("✅ 成功读取 JSON 数据，共", json.length, "条记录");
        return json;
      } catch (err) {
        console.error("❌ 加载 data.json 失败：", err);
        alert("无法读取数据文件，请确认路径正确（tz/data.json）并已在 GitHub Pages 发布。");
        return [];
      }
    }

    async function searchData() {
      const supplier = document.getElementById('supplier').value.trim();
      const projectId = document.getElementById('projectId').value.trim();
      const projectName = document.getElementById('projectName').value.trim();

      console.log("🔍 搜索条件：", { supplier, projectId, projectName });

      const data = await loadData();
      const resultTable = document.getElementById('resultTable');
      const totalAmountEl = document.getElementById('totalAmount');

      const filtered = data.filter(item => {
        const supplierMatch = supplier === "" || item.供应商名称.includes(supplier);
        const projectIdMatch = projectId === "" || item.项目号.includes(projectId);
        const projectNameMatch = projectName === "" || item.项目名称.includes(projectName);
        return supplierMatch && projectIdMatch && projectNameMatch;
      });

      resultTable.innerHTML = "";
      totalAmountEl.textContent = "";

      if (filtered.length === 0) {
        resultTable.innerHTML = `<tr><td colspan="8" class="text-center text-gray-400 py-4">未找到匹配的记录</td></tr>`;
        return;
      }

      let total = 0;
      filtered.forEach(row => {
        total += parseFloat(row.订单总额);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-3 py-2">${row.合同编号}</td>
          <td class="border px-3 py-2">${row.供应商名称}</td>
          <td class="border px-3 py-2">${row.项目号}</td>
          <td class="border px-3 py-2">${row.项目名称}</td>
          <td class="border px-3 py-2 text-right">${row.数量}</td>
          <td class="border px-3 py-2">${row.单位}</td>
          <td class="border px-3 py-2 text-right">${row.采购单价}</td>
          <td class="border px-3 py-2 text-right">${row.订单总额}</td>
        `;
        resultTable.appendChild(tr);
      });

      totalAmountEl.textContent = "💰 金额总计：" + total.toLocaleString() + " 元";
    }

    document.getElementById('searchBtn').addEventListener('click', searchData);
    document.addEventListener('keydown', e => { if (e.key === 'Enter') searchData(); });
  </script>
</body>
</html>
