<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>包装下单全流程跟踪表</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 1.8rem;
        }
        
        .controls {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-add {
            background: #2ecc71;
        }
        
        .btn-add:hover {
            background: #27ae60;
        }
        
        .btn-export {
            background: #9b59b6;
        }
        
        .btn-export:hover {
            background: #8e44ad;
        }
        
        .btn-details {
            background: #f39c12;
        }
        
        .btn-details:hover {
            background: #e67e22;
        }
        
        .btn-sort {
            background: #16a085;
        }
        
        .btn-sort:hover {
            background: #1abc9c;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1600px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }
        
        th {
            background: #34495e;
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e8f4fc;
        }
        
        .stage-header {
            background: #2c3e50 !important;
            color: white;
            font-weight: bold;
        }
        
        .stage-header td {
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }
        
        .status-not-started {
            background: #ecf0f1;
            color: #7f8c8d;
        }
        
        .status-in-progress {
            background: #fff9e6;
            color: #f39c12;
        }
        
        .status-completed {
            background: #e8f6f3;
            color: #27ae60;
        }
        
        .status-delayed {
            background: #fdeaea;
            color: #e74c3c;
        }
        
        .status-on-hold {
            background: #e8eaf6;
            color: #5c6bc0;
        }
        
        .progress-cell {
            min-width: 150px;
        }
        
        .progress-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: #2ecc71;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            font-size: 0.85rem;
            margin-top: 3px;
            text-align: center;
        }
        
        .date-input {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 8px;
            width: 100%;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #3498db;
            font-size: 1rem;
            transition: color 0.3s ease;
        }
        
        .action-btn:hover {
            color: #2980b9;
        }
        
        .action-btn.delete {
            color: #e74c3c;
        }
        
        .action-btn.delete:hover {
            color: #c0392b;
        }
        
        .notes-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .notes-cell:hover {
            white-space: normal;
            overflow: visible;
            background: #fff9e6;
            position: relative;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .summary {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .summary-item {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .summary-item h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3498db;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #2c3e50;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .details-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e1e1e1;
        }
        
        .details-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .sortable-ghost {
            opacity: 0.4;
        }
        
        .sortable-chosen {
            background-color: #e8f4fc;
        }
        
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
        }
        
        .sort-handle {
            cursor: move;
            color: #95a5a6;
            margin-right: 10px;
        }
        
        .sort-handle:hover {
            color: #3498db;
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-box-open"></i> 包装下单全流程跟踪表</h1>
            <div class="controls">
                <button class="btn btn-add" id="addTaskBtn">
                    <i class="fas fa-plus"></i> 添加任务
                </button>
                <button class="btn btn-sort" id="toggleSortBtn">
                    <i class="fas fa-arrows-alt"></i> 调整排序
                </button>
                <button class="btn btn-details" id="detailsBtn">
                    <i class="fas fa-info-circle"></i> 流程详情
                </button>
                <button class="btn btn-export" id="exportBtn">
                    <i class="fas fa-file-export"></i> 导出数据
                </button>
                <button class="btn" id="saveBtn">
                    <i class="fas fa-save"></i> 保存更改
                </button>
            </div>
        </header>
        
        <div class="table-container">
            <table id="processTable">
                <thead>
                    <tr>
                        <th width="3%">排序</th>
                        <th width="5%">序号</th>
                        <th width="14%">任务名称</th>
                        <th width="9%">负责人</th>
                        <th width="7%">计划开始</th>
                        <th width="7%">计划完成</th>
                        <th width="7%">实际开始</th>
                        <th width="7%">实际完成</th>
                        <th width="7%">状态</th>
                        <th width="7%">进度</th>
                        <th width="15%">关键注意事项</th>
                        <th width="7%">操作</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- 表格数据将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
        
        <div class="summary">
            <div class="summary-item">
                <h3>总任务数</h3>
                <div class="summary-value" id="totalTasks">0</div>
            </div>
            <div class="summary-item">
                <h3>已完成</h3>
                <div class="summary-value" id="completedTasks">0</div>
            </div>
            <div class="summary-item">
                <h3>进行中</h3>
                <div class="summary-value" id="inProgressTasks">0</div>
            </div>
            <div class="summary-item">
                <h3>整体进度</h3>
                <div class="summary-value" id="overallProgress">0%</div>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑任务模态框 -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">添加新任务</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="form-group">
                    <label for="taskName">任务名称</label>
                    <input type="text" id="taskName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="taskOwner">负责人</label>
                    <input type="text" id="taskOwner" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="plannedStart">计划开始日期</label>
                    <input type="date" id="plannedStart" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="plannedEnd">计划完成日期</label>
                    <input type="date" id="plannedEnd" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="actualStart">实际开始日期</label>
                    <input type="date" id="actualStart" class="form-control">
                </div>
                <div class="form-group">
                    <label for="actualEnd">实际完成日期</label>
                    <input type="date" id="actualEnd" class="form-control">
                </div>
                <div class="form-group">
                    <label for="taskStatus">状态</label>
                    <select id="taskStatus" class="form-control" required>
                        <option value="not-started">未开始</option>
                        <option value="in-progress">进行中</option>
                        <option value="completed">已完成</option>
                        <option value="delayed">已延期</option>
                        <option value="on-hold">暂停</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskProgress">进度 (%)</label>
                    <input type="number" id="taskProgress" class="form-control" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label for="taskNotes">关键注意事项</label>
                    <textarea id="taskNotes" class="form-control" placeholder="请输入该任务的关键注意事项..."></textarea>
                </div>
                
                <div class="details-section" id="detailsSection">
                    <h3>详细信息</h3>
                    <div class="details-grid">
                        <div class="form-group">
                            <label for="taskStage">所属阶段</label>
                            <select id="taskStage" class="form-control">
                                <option value="preparation">前期准备阶段</option>
                                <option value="sourcing">供应商选择与打样</option>
                                <option value="decision">比价与决策</option>
                                <option value="production">生产阶段</option>
                                <option value="delivery">发货与验收</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskPriority">优先级</label>
                            <select id="taskPriority" class="form-control">
                                <option value="low">低</option>
                                <option value="medium">中</option>
                                <option value="high">高</option>
                                <option value="critical">紧急</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn" id="cancelBtn">取消</button>
                    <button type="submit" class="btn btn-add">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 流程详情模态框 -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">包装下单全流程指南</h2>
                <button class="close-modal" id="closeDetailsModal">&times;</button>
            </div>
            <div>
                <h3>第一阶段：前期准备阶段</h3>
                <ul>
                    <li><strong>产品立项：</strong>明确产品需求、目标市场、预算范围</li>
                    <li><strong>产品设计：</strong>完成产品外观、结构、功能设计</li>
                    <li><strong>产品备案：</strong>完成相关法规要求的备案手续</li>
                    <li><strong>注意事项：</strong>确保设计符合生产要求，备案资料齐全</li>
                </ul>
                
                <h3>第二阶段：供应商选择与打样</h3>
                <ul>
                    <li><strong>选择供应商：</strong>评估供应商资质、生产能力、质量体系</li>
                    <li><strong>产品打样：</strong>要求供应商提供样品进行测试和评估</li>
                    <li><strong>注意事项：</strong>样品需符合设计要求和质量标准</li>
                </ul>
                
                <h3>第三阶段：比价与决策</h3>
                <ul>
                    <li><strong>三方比价：</strong>收集至少三家供应商的报价进行对比</li>
                    <li><strong>接收计划下单指令：</strong>确认最终供应商和下单数量</li>
                    <li><strong>注意事项：</strong>综合考虑价格、质量、交期和服务</li>
                </ul>
                
                <h3>第四阶段：生产阶段</h3>
                <ul>
                    <li><strong>安排产前样：</strong>确认大货生产前的最终样品</li>
                    <li><strong>下单生产包装：</strong>正式下达生产订单</li>
                    <li><strong>现场监督生产：</strong>定期检查生产进度和质量</li>
                    <li><strong>注意事项：</strong>确保生产过程符合质量要求，及时解决问题</li>
                </ul>
                
                <h3>第五阶段：发货与验收</h3>
                <ul>
                    <li><strong>沟通发货细节：</strong>确认运输方式、包装要求、发货时间</li>
                    <li><strong>大货到厂：</strong>接收并验收大货产品</li>
                    <li><strong>注意事项：</strong>检查数量、质量、包装完整性，及时处理问题</li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" id="closeDetailsBtn">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 包装下单流程任务数据
        let tasks = [
            { 
                id: 1, 
                name: "产品立项", 
                owner: "产品经理", 
                plannedStart: "2023-11-01", 
                plannedEnd: "2023-11-05", 
                actualStart: "2023-11-01", 
                actualEnd: "2023-11-05", 
                status: "completed", 
                progress: 100, 
                notes: "明确产品需求、目标市场、预算范围、时间节点",
                stage: "preparation",
                priority: "high",
                order: 1
            },
            { 
                id: 2, 
                name: "产品设计", 
                owner: "设计部", 
                plannedStart: "2023-11-03", 
                plannedEnd: "2023-11-15", 
                actualStart: "2023-11-04", 
                actualEnd: "", 
                status: "in-progress", 
                progress: 80, 
                notes: "完成产品外观、结构、功能设计，确保设计符合生产要求",
                stage: "preparation",
                priority: "high",
                order: 2
            },
            { 
                id: 3, 
                name: "产品备案", 
                owner: "法规部", 
                plannedStart: "2023-11-10", 
                plannedEnd: "2023-11-20", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "完成相关法规要求的备案手续，准备齐全备案资料",
                stage: "preparation",
                priority: "medium",
                order: 3
            },
            { 
                id: 4, 
                name: "选择供应商", 
                owner: "采购部", 
                plannedStart: "2023-11-15", 
                plannedEnd: "2023-11-25", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "评估供应商资质、生产能力、质量体系、过往业绩",
                stage: "sourcing",
                priority: "high",
                order: 4
            },
            { 
                id: 5, 
                name: "产品打样", 
                owner: "质量部", 
                plannedStart: "2023-11-20", 
                plannedEnd: "2023-12-05", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "要求供应商提供样品进行测试和评估，确保样品符合设计要求和质量标准",
                stage: "sourcing",
                priority: "high",
                order: 5
            },
            { 
                id: 6, 
                name: "三方比价", 
                owner: "采购部", 
                plannedStart: "2023-11-25", 
                plannedEnd: "2023-12-05", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "收集至少三家供应商的报价进行对比，综合考虑价格、质量、交期和服务",
                stage: "decision",
                priority: "medium",
                order: 6
            },
            { 
                id: 7, 
                name: "接收计划下单指令", 
                owner: "计划部", 
                plannedStart: "2023-12-01", 
                plannedEnd: "2023-12-05", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "确认最终供应商和下单数量，准备下单资料",
                stage: "decision",
                priority: "high",
                order: 7
            },
            { 
                id: 8, 
                name: "安排产前样", 
                owner: "质量部", 
                plannedStart: "2023-12-05", 
                plannedEnd: "2023-12-12", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "确认大货生产前的最终样品，确保与确认样一致",
                stage: "production",
                priority: "high",
                order: 8
            },
            { 
                id: 9, 
                name: "下单生产包装", 
                owner: "采购部", 
                plannedStart: "2023-12-08", 
                plannedEnd: "2023-12-10", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "正式下达生产订单，确认交期、数量、质量要求",
                stage: "production",
                priority: "high",
                order: 9
            },
            { 
                id: 10, 
                name: "现场监督生产", 
                owner: "生产部", 
                plannedStart: "2023-12-12", 
                plannedEnd: "2023-12-30", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "定期检查生产进度和质量，确保生产过程符合质量要求，及时解决问题",
                stage: "production",
                priority: "medium",
                order: 10
            },
            { 
                id: 11, 
                name: "沟通发货细节", 
                owner: "物流部", 
                plannedStart: "2023-12-25", 
                plannedEnd: "2023-12-28", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "确认运输方式、包装要求、发货时间、收货地址等细节",
                stage: "delivery",
                priority: "medium",
                order: 11
            },
            { 
                id: 12, 
                name: "大货到厂", 
                owner: "仓库", 
                plannedStart: "2024-01-05", 
                plannedEnd: "2024-01-10", 
                actualStart: "", 
                actualEnd: "", 
                status: "not-started", 
                progress: 0, 
                notes: "接收并验收大货产品，检查数量、质量、包装完整性，及时处理问题",
                stage: "delivery",
                priority: "medium",
                order: 12
            }
        ];

        // DOM元素
        const tableBody = document.getElementById('tableBody');
        const taskModal = document.getElementById('taskModal');
        const detailsModal = document.getElementById('detailsModal');
        const taskForm = document.getElementById('taskForm');
        const modalTitle = document.getElementById('modalTitle');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const toggleSortBtn = document.getElementById('toggleSortBtn');
        const detailsBtn = document.getElementById('detailsBtn');
        const closeModal = document.getElementById('closeModal');
        const closeDetailsModal = document.getElementById('closeDetailsModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeDetailsBtn = document.getElementById('closeDetailsBtn');
        const saveBtn = document.getElementById('saveBtn');
        const exportBtn = document.getElementById('exportBtn');

        let isSortMode = false;
        let sortable = null;

        // 初始化表格
        function renderTable() {
            tableBody.innerHTML = '';
            
            // 按阶段分组
            const stages = {
                preparation: { name: "第一阶段：前期准备阶段", tasks: [] },
                sourcing: { name: "第二阶段：供应商选择与打样", tasks: [] },
                decision: { name: "第三阶段：比价与决策", tasks: [] },
                production: { name: "第四阶段：生产阶段", tasks: [] },
                delivery: { name: "第五阶段：发货与验收", tasks: [] }
            };
            
            // 将任务按阶段分组
            tasks.forEach(task => {
                if (stages[task.stage]) {
                    stages[task.stage].tasks.push(task);
                }
            });
            
            // 按order排序
            Object.values(stages).forEach(stage => {
                stage.tasks.sort((a, b) => a.order - b.order);
            });
            
            // 渲染每个阶段的任务
            Object.values(stages).forEach(stage => {
                // 添加阶段标题行
                if (stage.tasks.length > 0) {
                    const stageRow = document.createElement('tr');
                    stageRow.className = 'stage-header';
                    stageRow.innerHTML = `<td colspan="12">${stage.name}</td>`;
                    tableBody.appendChild(stageRow);
                }
                
                // 添加阶段内的任务
                stage.tasks.forEach((task, index) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', task.id);
                    
                    // 状态标签
                    let statusClass = '';
                    let statusText = '';
                    
                    switch(task.status) {
                        case 'not-started':
                            statusClass = 'status-not-started';
                            statusText = '未开始';
                            break;
                        case 'in-progress':
                            statusClass = 'status-in-progress';
                            statusText = '进行中';
                            break;
                        case 'completed':
                            statusClass = 'status-completed';
                            statusText = '已完成';
                            break;
                        case 'delayed':
                            statusClass = 'status-delayed';
                            statusText = '已延期';
                            break;
                        case 'on-hold':
                            statusClass = 'status-on-hold';
                            statusText = '暂停';
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>
                            ${isSortMode ? '<i class="fas fa-arrows-alt sort-handle"></i>' : ''}
                            ${task.order}
                        </td>
                        <td>${task.id}</td>
                        <td>${task.name}</td>
                        <td>${task.owner}</td>
                        <td><input type="date" class="date-input" value="${task.plannedStart}" data-field="plannedStart" data-id="${task.id}"></td>
                        <td><input type="date" class="date-input" value="${task.plannedEnd}" data-field="plannedEnd" data-id="${task.id}"></td>
                        <td><input type="date" class="date-input" value="${task.actualStart}" data-field="actualStart" data-id="${task.id}"></td>
                        <td><input type="date" class="date-input" value="${task.actualEnd}" data-field="actualEnd" data-id="${task.id}"></td>
                        <td>
                            <select class="status-select" data-id="${task.id}">
                                <option value="not-started" ${task.status === 'not-started' ? 'selected' : ''}>未开始</option>
                                <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>进行中</option>
                                <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>已完成</option>
                                <option value="delayed" ${task.status === 'delayed' ? 'selected' : ''}>已延期</option>
                                <option value="on-hold" ${task.status === 'on-hold' ? 'selected' : ''}>暂停</option>
                            </select>
                        </td>
                        <td class="progress-cell">
                            <div>${task.progress}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress}%"></div>
                            </div>
                            <input type="range" min="0" max="100" value="${task.progress}" class="progress-slider" data-id="${task.id}">
                        </td>
                        <td class="notes-cell">${task.notes}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit" data-id="${task.id}"><i class="fas fa-edit"></i></button>
                                ${isSortMode ? '' : '<button class="action-btn delete" data-id="${task.id}"><i class="fas fa-trash"></i></button>'}
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            });
            
            // 更新统计信息
            updateSummary();
            
            // 添加事件监听器
            addEventListeners();
            
            // 初始化排序功能
            if (isSortMode) {
                initSortable();
            }
        }
        
        // 初始化排序功能
        function initSortable() {
            if (sortable) {
                sortable.destroy();
            }
            
            sortable = new Sortable(tableBody, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                handle: '.sort-handle',
                filter: '.stage-header',
                onEnd: function(evt) {
                    // 获取移动后的任务ID
                    const movedTaskId = parseInt(evt.item.getAttribute('data-id'));
                    
                    // 找到移动的任务
                    const movedTask = tasks.find(task => task.id === movedTaskId);
                    if (!movedTask) return;
                    
                    // 获取同一阶段的所有任务
                    const stageTasks = tasks.filter(task => task.stage === movedTask.stage);
                    
                    // 更新order值
                    stageTasks.forEach((task, index) => {
                        task.order = index + 1;
                    });
                    
                    // 保存并重新渲染
                    saveToLocalStorage();
                    renderTable();
                }
            });
        }
        
        // 切换排序模式
        function toggleSortMode() {
            isSortMode = !isSortMode;
            toggleSortBtn.innerHTML = isSortMode ? 
                '<i class="fas fa-check"></i> 完成排序' : 
                '<i class="fas fa-arrows-alt"></i> 调整排序';
            
            toggleSortBtn.style.background = isSortMode ? '#e74c3c' : '#16a085';
            toggleSortBtn.style.color = 'white';
            
            renderTable();
        }
        
        // 更新统计信息
        function updateSummary() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const inProgressTasks = tasks.filter(task => task.status === 'in-progress').length;
            const overallProgress = tasks.reduce((sum, task) => sum + task.progress, 0) / totalTasks;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('overallProgress').textContent = overallProgress.toFixed(1) + '%';
        }
        
        // 添加事件监听器
        function addEventListeners() {
            // 日期输入框变化
            document.querySelectorAll('.date-input').forEach(input => {
                input.addEventListener('change', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    const field = this.getAttribute('data-field');
                    const value = this.value;
                    
                    updateTask(taskId, field, value);
                });
            });
            
            // 状态选择变化
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    const value = this.value;
                    
                    updateTask(taskId, 'status', value);
                    
                    // 如果状态变为已完成，自动设置进度为100%
                    if (value === 'completed') {
                        updateTask(taskId, 'progress', 100);
                    }
                    
                    renderTable();
                });
            });
            
            // 进度滑块变化
            document.querySelectorAll('.progress-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    const value = parseInt(this.value);
                    
                    updateTask(taskId, 'progress', value);
                    renderTable();
                });
            });
            
            // 编辑按钮
            document.querySelectorAll('.action-btn.edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    editTask(taskId);
                });
            });
            
            // 删除按钮
            document.querySelectorAll('.action-btn.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    deleteTask(taskId);
                });
            });
        }
        
        // 更新任务
        function updateTask(id, field, value) {
            const taskIndex = tasks.findIndex(task => task.id === id);
            if (taskIndex !== -1) {
                tasks[taskIndex][field] = value;
                
                // 自动更新状态
                if (field === 'progress') {
                    const progress = parseInt(value);
                    if (progress === 0) {
                        tasks[taskIndex].status = 'not-started';
                    } else if (progress > 0 && progress < 100) {
                        tasks[taskIndex].status = 'in-progress';
                    } else if (progress === 100) {
                        tasks[taskIndex].status = 'completed';
                    }
                }
                
                // 保存到本地存储
                saveToLocalStorage();
            }
        }
        
        // 编辑任务
        function editTask(id) {
            const task = tasks.find(task => task.id === id);
            if (task) {
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskOwner').value = task.owner;
                document.getElementById('plannedStart').value = task.plannedStart;
                document.getElementById('plannedEnd').value = task.plannedEnd;
                document.getElementById('actualStart').value = task.actualStart;
                document.getElementById('actualEnd').value = task.actualEnd;
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskProgress').value = task.progress;
                document.getElementById('taskNotes').value = task.notes;
                document.getElementById('taskStage').value = task.stage;
                document.getElementById('taskPriority').value = task.priority;
                
                modalTitle.textContent = '编辑任务';
                taskModal.style.display = 'flex';
            }
        }
        
        // 删除任务
        function deleteTask(id) {
            if (confirm('确定要删除这个任务吗？')) {
                tasks = tasks.filter(task => task.id !== id);
                renderTable();
                saveToLocalStorage();
            }
        }
        
        // 添加新任务
        function addNewTask() {
            // 重置表单
            taskForm.reset();
            document.getElementById('taskId').value = '';
            modalTitle.textContent = '添加新任务';
            taskModal.style.display = 'flex';
        }
        
        // 保存任务（表单提交）
        taskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const taskId = document.getElementById('taskId').value;
            const stage = document.getElementById('taskStage').value;
            
            const taskData = {
                name: document.getElementById('taskName').value,
                owner: document.getElementById('taskOwner').value,
                plannedStart: document.getElementById('plannedStart').value,
                plannedEnd: document.getElementById('plannedEnd').value,
                actualStart: document.getElementById('actualStart').value,
                actualEnd: document.getElementById('actualEnd').value,
                status: document.getElementById('taskStatus').value,
                progress: parseInt(document.getElementById('taskProgress').value),
                notes: document.getElementById('taskNotes').value,
                stage: stage,
                priority: document.getElementById('taskPriority').value
            };
            
            if (taskId) {
                // 更新现有任务
                const taskIndex = tasks.findIndex(task => task.id === parseInt(taskId));
                if (taskIndex !== -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                }
            } else {
                // 添加新任务
                const newId = tasks.length > 0 ? Math.max(...tasks.map(task => task.id)) + 1 : 1;
                
                // 计算新任务的order值
                const stageTasks = tasks.filter(task => task.stage === stage);
                const maxOrder = stageTasks.length > 0 ? Math.max(...stageTasks.map(task => task.order)) : 0;
                
                tasks.push({ 
                    id: newId, 
                    order: maxOrder + 1,
                    ...taskData 
                });
            }
            
            renderTable();
            taskModal.style.display = 'none';
            saveToLocalStorage();
        });
        
        // 保存到本地存储
        function saveToLocalStorage() {
            localStorage.setItem('packagingTasks', JSON.stringify(tasks));
        }
        
        // 从本地存储加载
        function loadFromLocalStorage() {
            const savedTasks = localStorage.getItem('packagingTasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
        }
        
        // 导出数据
        function exportData() {
            const dataStr = JSON.stringify(tasks, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = '包装下单流程数据.json';
            link.click();
        }
        
        // 显示流程详情
        function showDetails() {
            detailsModal.style.display = 'flex';
        }
        
        // 事件监听
        addTaskBtn.addEventListener('click', addNewTask);
        toggleSortBtn.addEventListener('click', toggleSortMode);
        detailsBtn.addEventListener('click', showDetails);
        closeModal.addEventListener('click', () => taskModal.style.display = 'none');
        closeDetailsModal.addEventListener('click', () => detailsModal.style.display = 'none');
        closeDetailsBtn.addEventListener('click', () => detailsModal.style.display = 'none');
        cancelBtn.addEventListener('click', () => taskModal.style.display = 'none');
        saveBtn.addEventListener('click', () => saveToLocalStorage());
        exportBtn.addEventListener('click', exportData);
        
        // 点击模态框外部关闭
        window.addEventListener('click', (e) => {
            if (e.target === taskModal) {
                taskModal.style.display = 'none';
            }
            if (e.target === detailsModal) {
                detailsModal.style.display = 'none';
            }
        });
        
        // 初始化
        loadFromLocalStorage();
        renderTable();
    </script>
</body>
</html>